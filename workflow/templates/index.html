<!DOCTYPE html>
<html>
<head>
    {% load static %}

    <meta charset="UTF-8"/>
    <meta
            name="viewport"
            content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui"
    />
    <title>Celery workflow</title>

    <style>

        @font-face {
            font-family: 'Roboto';
            font-style: normal;
            font-weight: 400;
            src: local('Roboto'), local('Roboto-Regular'), url({% static '/fonts/Roboto/Roboto-Regular.ttf' %}) format('truetype');
        }

        @font-face {
            font-family: 'Roboto Light';
            font-style: normal;
            font-weight: 300;
            src: local('Roboto Light'), local('Roboto-Light'), url({% static '/fonts/Roboto/Roboto-Light.ttf' %}) format('truetype');
        }



        @font-face {
            font-family: 'Roboto Medium';
            font-style: normal;
            font-weight: 500;
            src: local('Roboto Medium'), local('Roboto-Medium'), url({% static '/fonts/Roboto/Roboto-Medium.ttf' %}) format('truetype');
        }



        @font-face {
            font-family: 'Roboto Bold';
            font-style: normal;
            font-weight: 700;
            src: local('Roboto Bold'), local('Roboto-Bold'), url({% static '/fonts/Roboto/Roboto-Bold.ttf' %}) format('truetype');
        }

        @font-face {
            font-family: "Material Design Icons";
            src: url({% static '/fonts/materialdesignicons-webfont.eot' %});
            src: url({% static '/fonts/materialdesignicons-webfont.eot' %}) format("embedded-opentype"),
                    url({% static '/fonts/materialdesignicons-webfont.woff2' %}) format("woff2"),
                    url({% static '/fonts/materialdesignicons-webfont.woff' %}) format("woff"),
                    url({% static '/fonts/materialdesignicons-webfont.ttf' %}) format("truetype");
            font-weight: normal;
            font-style: normal
        }

    </style>

    <link
            rel="stylesheet"
            href="{% static 'css/vuetify.css' %}"
    />
    <link
            rel="stylesheet"
            href="{% static 'css/icons.css' %}"
    />
    <link
            rel="stylesheet"
            href="{% static 'css/toastr.css' %}"
    />

    <link
            rel="stylesheet"
            href="{% static 'style.css' %}"
    />
    <link
            rel="stylesheet"
            href="{% static 'finmars-error.css' %}"
    />

    <script type="text/javascript">
        const API_URL = "/{{ BASE_API_URL }}/workflow/api";
        const FLOWER_URL = '{{ FLOWER_URL }}';
        const DOCUMENTATION_LINK = '{{ DOCUMENTATION_LINK }}';
        const LOG_LINK = '{{ LOG_LINK }}';
    </script>

    <script src="{% static 'scripts/jquery.min.js' %}"></script>
    <script src="{% static 'scripts/vue.js' %}"></script>
    <script src="{% static 'scripts/vue-router.js' %}"></script>

    <script src="{% static 'scripts/vuex.js' %}"></script>
    <script src="{% static 'scripts/vuetify.js' %}"></script>

    <script src="{% static 'scripts/moment.min.js' %}"></script>

    <script src="{% static 'scripts/axios.min.js' %}"></script>

    <script src="{% static 'scripts/d3.min.js' %}"></script>

    <script src="{% static 'scripts/dagre-d3.min.js' %}"></script>

    <script src="{% static 'scripts/toastr.min.js' %}"></script>


</head>

<body>
{% verbatim %}
<div id="app" v-cloak>
    <div id="app" v-cloak>
        <v-app id="inspire">
            <v-app-bar app clipped-right color="director" dark>
                <v-app-bar-nav-icon @click="drawer = true, moveUp()"></v-app-bar-nav-icon>
                <router-link to="/" tag="span" style="cursor: pointer">
                    <v-toolbar-title @click="isHome = true"
                    >Celery Director
                    </v-toolbar-title
                    >
                </router-link>
                <v-spacer></v-spacer>

                <v-tooltip bottom>
                    <template v-slot:activator="{ on, attrs }">
                        <v-btn
                                tile
                                outlined
                                color="director"
                                style="margin-right: 8px;"
                                v-on="on"
                                v-bind="attrs"
                                @click.stop="toggleAutoRefresh()"
                        >
                            <v-icon v-if="autoRefresh">mdi-sync</v-icon>
                            <v-icon v-if="!autoRefresh">mdi-sync-off</v-icon>
                        </v-btn>
                    </template>
                    <span v-if="autoRefresh">Disable Auto Refresh</span>
                    <span v-if="!autoRefresh">Enable Auto Refresh</span>
                </v-tooltip>

                <v-tooltip bottom>
                    <template v-slot:activator="{ on, attrs }">
                        <v-btn
                                tile
                                outlined
                                color="director"
                                style="margin-right: 8px;"
                                v-on="on"
                                v-bind="attrs"
                                @click.stop="refreshStorage()"
                        >
                            <v-icon>mdi-cloud-refresh</v-icon>
                        </v-btn>
                    </template>
                    <span>Refresh Storage</span>
                </v-tooltip>

            </v-app-bar>
            <!-- Drawer Begins-->
            <v-navigation-drawer v-model="drawer" absolute temporary>
                <v-list nav dense>
                    <v-list-item-group
                            v-model="group"
                            active-class="grey--text text--accent-4"
                    >
                        <router-link to="/">
                            <button style="margin-left: 1em" @click="isHome = true">
                                <v-list-item>
                                    <v-list-item-icon>
                                        <v-icon>mdi-home</v-icon>
                                    </v-list-item-icon>
                                    <v-list-item-title>Home</v-list-item-title>
                                </v-list-item>
                            </button>
                        </router-link>

                        <router-link to="/definitions">
                            <button
                                    style="margin-left: 1em"
                                    @click="isHome = false"
                            >
                                <v-list-item>
                                    <v-list-item-icon>
                                        <v-icon>mdi-format-list-bulleted</v-icon>
                                    </v-list-item-icon>
                                    <v-list-item-title>Definitions</v-list-item-title>
                                </v-list-item>
                            </button>
                        </router-link>
                        <a :href="docLink" class="text-decoration-none" target="_blank">
                            <button style="margin-left: 1em">
                                <v-list-item>
                                    <v-list-item-icon>
                                        <v-icon>mdi-book-open-variant</v-icon>
                                    </v-list-item-icon>
                                    <v-list-item-title>Documentation</v-list-item-title>
                                </v-list-item>
                            </button>
                        </a>
                        <a :href="logLink" class="text-decoration-none" target="_blank">
                            <button style="margin-left: 1em">
                                <v-list-item>
                                    <v-list-item-icon>
                                        <v-icon>mdi-clipboard-text</v-icon>
                                    </v-list-item-icon>
                                    <v-list-item-title>Logs</v-list-item-title>
                                </v-list-item>
                            </button>
                        </a>

                    </v-list-item-group>
                </v-list>
            </v-navigation-drawer>
            <!-- Drawer Ends-->

            <!-- Home Begins -->
            <v-main v-if="isHome==true">
                <v-container v-if="!$route.params.id">
                    <v-row>
                        <v-col cols="12" md="8">
                            <v-card class="pa-4" outlined>
                                <div>Workflows</div>
                                <v-card-text>


                                    <div class="v-data-table theme--dark">

                                        <div class="v-data-table__wrapper">

                                            <table>

                                                <thead>

                                                <tr>
                                                    <th>Status
                                                    </th>
                                                    <th>
                                                        Id
                                                    </th>
                                                    <th>
                                                        User Code
                                                    </th>
                                                    <th>
                                                        Role
                                                    </th>
                                                    <th>Date
                                                    </th>
                                                </tr>
                                                </thead>
                                                <tbody>

                                                <tr v-for="item in workflows"
                                                    class="pointer"
                                                    @click="selectRow(item)"
                                                    :class="{'active': item.isSelected}"
                                                >
                                                    <td>
                                                        <v-avatar
                                                                size="14"
                                                                :color="item.status | statusColor"
                                                        ></v-avatar>
                                                    </td>
                                                    <td>{{ item.id }}</td>
                                                    <td>{{ item.user_code }}</td>
                                                    <td>
                                                        <span v-if="item.is_manager">Manager</span>
                                                        <span v-if="!item.is_manager">Worker</span>
                                                    </td>
                                                    <td v-bind:title="item.created">
                                                        <v-ship>{{ item.created | formatDate }}</v-ship>
                                                    </td>
                                                </tr>

                                                </tbody>


                                            </table>

                                        </div>
                                    </div>


                                    <div class="pagination">
                                        <button @click="changePage(page - 1)" :disabled="page === 1">Previous</button>
                                        <button v-for="pageItem in totalPages" :key="pageItem"
                                                @click="changePage(pageItem)"
                                                :disabled="page === pageItem">{{ pageItem }}
                                        </button>
                                        <button @click="changePage(page + 1)" :disabled="page === totalPages">Next
                                        </button>
                                    </div>


                                </v-card-text>
                            </v-card>
                        </v-col>
                        <v-col cols="6" md="4">
                            <v-card class="pa-4 mb-4" outlined tile>
                                <div>Search</div>
                                <v-card-text>
                                    <v-text-field
                                            v-model="query"
                                            label="Search by Date/ID"
                                            label="Append"
                                            append-icon="mdi-magnify"
                                            single-line
                                            hide-details
                                    ></v-text-field>
                                </v-card-text>
                            </v-card>
                            <!--<v-card class="pa-4 mb-4" outlined tile>
                                <div>Filter by workflow</div>
                                <v-card-text>
                                    <v-chip-group
                                            v-model="selectedWorkflowName"
                                            active-class="primary--text"
                                            column
                                    >
                                        <v-chip
                                                label
                                                outlined
                                                v-for="name in workflowNames"
                                                :key="name"
                                                :value="name"
                                        >
                                            {{ name }}
                                        </v-chip>
                                    </v-chip-group>
                                </v-card-text>
                            </v-card>
                            <v-card class="pa-4 mb-4" outlined tile>
                                <div>Filter by status</div>
                                <v-card-text>
                                    <v-select
                                            v-model="selectedStatus"
                                            :items="status"
                                            label="Select the status"
                                            multiple
                                            chips
                                    >
                                    </v-select>
                                </v-card-text>
                            </v-card> -->
                        </v-col>
                    </v-row>
                </v-container>
                <v-container class="fill-height" fluid v-if="$route.params.id">
                    <v-row no-gutters>
                        <v-col cols="12" md="12">
                            <div class="graph">
                                <svg width="100%" height="600" class="svg-main">
                                    <g/>
                                </svg>
                            </div>
                        </v-col>
                    </v-row>
                    <v-row no-gutters>
                        <v-col cols="12" md="12">
                            <div v-bind:class="{'graph': true, 'd-none': hideHooks}">
                                <v-divider class="mt-2 mb-2"></v-divider>
                                <v-subheader class="mb-2">Hooks triggered</v-subheader>
                                <svg width="100%" height="200" class="svg-hooks">
                                    <g/>
                                </svg>
                            </div>
                        </v-col>
                    </v-row>
                    <v-navigation-drawer
                            width="50%"
                            v-if="selectedWorkflow"
                            app
                            clipped
                            right
                            fixed
                    >
                        <template v-slot:prepend v-if="selectedWorkflow">
                            <v-list-item three-line class="workflow">
                                <v-list-item-content>
                                    <div class="overline mb-3">
                                        {{ selectedWorkflow.created | formatDate }}
                                    </div>
                                    <v-list-item-title class="headline">
                                        {{ selectedWorkflow.fullname }}
                                        <v-chip
                                                v-if="selectedWorkflow.periodic"
                                                class="ma-2"
                                                small
                                        >periodic
                                        </v-chip
                                        >
                                        <v-chip
                                                small
                                                :color="getColor(selectedWorkflow.status)"
                                                dark
                                        >{{ selectedWorkflow.status }}
                                        </v-chip
                                        >
                                    </v-list-item-title>
                                    <v-list-item-subtitle class="mt-2">
                                        <u>Tasks :</u> Total
                                        <strong>{{ selectedWorkflow.tasks.length }}</strong> /
                                        Success
                                        <strong
                                        >{{
                                                selectedWorkflow.tasks |
                                                        countTasksByStatus('success')
                                            }}</strong
                                        >
                                        / Error
                                        <strong
                                        >{{ selectedWorkflow.tasks | countTasksByStatus('error') }}</strong
                                        >
                                    </v-list-item-subtitle>
                                </v-list-item-content>
                                <v-tooltip bottom>
                                    <template v-slot:activator="{ on, attrs }">
                                        <v-btn
                                                class="ma-2"
                                                tile
                                                outlined
                                                color="director"
                                                v-on="on"
                                                v-bind="attrs"
                                                @click.stop="refreshTask()"
                                        >
                                            <v-icon>mdi-refresh</v-icon>
                                        </v-btn>
                                    </template>
                                    <span>Refresh</span>
                                </v-tooltip>
                                <v-tooltip bottom>
                                    <template v-slot:activator="{ on, attrs }">
                                        <v-btn
                                                tile
                                                outlined
                                                color="director"
                                                v-on="on"
                                                v-bind="attrs"
                                                @click.stop="relaunchDialog = true"
                                        >
                                            <v-icon>mdi-play-circle</v-icon>
                                        </v-btn>
                                    </template>
                                    <span>Relaunch</span>
                                </v-tooltip>
                                <v-tooltip bottom>
                                    <template v-slot:activator="{ on, attrs }">
                                        <v-btn
                                                class="ma-2 terminate-workflow"
                                                tile
                                                outlined
                                                color="director"
                                                v-on="on"
                                                v-bind="attrs"
                                                @click.stop="cancelDialog = true"
                                        >
                                            <v-icon>mdi-cancel</v-icon>
                                        </v-btn>
                                    </template>
                                    <span>Terminate</span>
                                </v-tooltip>
                                <v-tooltip bottom>
                                    <template v-slot:activator="{ on, attrs }">
                                        <v-btn
                                                tile
                                                outlined
                                                color="director"
                                                v-on="on"
                                                v-bind="attrs"
                                                @click.stop="payloadDialog = true"
                                        >
                                            <v-icon>mdi-format-list-bulleted</v-icon>
                                        </v-btn>
                                    </template>
                                    <span>Payload</span>
                                </v-tooltip>
                            </v-list-item>
                            <v-divider class="mt-2 mb-4"></v-divider>
                        </template>
                        <v-row
                                v-if="!selectedTask"
                                class="mt-4"
                                justify="center"
                                no-gutters
                        >
                            <v-col lg="10">
                                <v-alert
                                        color="#3c4652"
                                        dark
                                        icon="mdi-alert-circle-outline"
                                        outlined
                                        border="left"
                                >
                                    Select a task to display its details
                                </v-alert>
                            </v-col>
                        </v-row>
                        <div v-if="selectedTask" class="pa-4">

                            <h2 class="text-center" style="margin-bottom: 8px">Task</h2>

                            <div class="v-data-table theme--dark">

                                <div class="v-data-table__wrapper">
                                    <table>
                                        <tbody>
                                        <tr>
                                            <td><strong>ID</strong></td>
                                            <td>{{ selectedTask.id }}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Key</strong></td>
                                            <td>{{ selectedTask.name }}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Task Status</strong></td>
                                            <td>
                                                <v-chip
                                                        small
                                                        :color="getColor(selectedTask.status)"
                                                        dark
                                                >{{ selectedTask.status }}
                                                </v-chip
                                                >
                                            </td>
                                        </tr>
                                        <tr>
                                            <td><strong>Created</strong></td>
                                            <td>{{ selectedTask.created | formatDate }}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Updated</strong></td>
                                            <td>{{ selectedTask.updated | formatDate }}</td>
                                        </tr>
                                        </tbody>
                                    </table>

                                </div>
                            </div>

                            <div v-if="selectedTask.log">
                                <h2 class="text-center" style="margin-bottom: 8px">Log</h2>
                                <code style="max-height: 300px;"

                                >{{ selectedTask.log }}</code
                                >
                            </div>

                            <div v-if="selectedTask.progress">
                                <h2 class="text-center" style="margin-bottom: 8px">Progress</h2>
                                <code

                                >{{ selectedTask.progress }}</code
                                >
                            </div>

                            <v-row
                                    v-if="!selectedTask.result"
                                    class="mt-4"
                                    justify="center"
                                    no-gutters
                            >
                                <v-col>
                                    <v-alert
                                            color="#3c4652"
                                            dark
                                            icon="mdi-alert-circle-outline"
                                            outlined
                                    >
                                        No task result
                                    </v-alert>
                                </v-col>
                            </v-row>

                            <div>
                                <h2 class="text-center" style="margin-bottom: 8px">Result</h2>
                                <code
                                        v-if="selectedTask.result && selectedTask.status != 'error'"
                                >{{ selectedTask.result }}</code
                                >
                                <div
                                        v-if="selectedTask.result && selectedTask.status == 'error'"
                                >
                                    <v-row class="mt-4" justify="center" no-gutters>
                                        <v-col>
                                            <v-alert
                                                    text
                                                    outlined
                                                    color="red darken-1"
                                                    icon="mdi-alert-circle-outline"
                                                    dark
                                                    icon="mdi-alert-circle-outline"
                                                    outlined
                                            >
                                                {{ selectedTask.result.exception }}
                                            </v-alert>
                                        </v-col>
                                    </v-row>
                                    <code>{{ selectedTask.result.traceback }}</code>
                                </div>
                            </div>


                        </div>
                        <template v-slot:append v-if="selectedTask
					    && (selectedWorkflow.status == 'success'
					    || selectedTask.is_hook == false)">
                            <div class="pa-6">
                                <v-btn
                                        block
                                        v-bind:href="getFlowerTaskUrl()"
                                        target="_blank"
                                        outlined
                                        color="director"
                                >
                                    <v-icon left>mdi-launch</v-icon>
                                    View in Flower
                                </v-btn>
                            </div>
                        </template>
                    </v-navigation-drawer>
                </v-container>
                <v-dialog v-model="cancelDialog" max-width="650">
                    <v-card v-if="selectedWorkflow">
                        <v-card-title>
                            Cancel the workflow
                            <v-spacer></v-spacer>
                        </v-card-title>
                        <v-divider></v-divider>
                        <v-card-text class="mt-5">
                            <v-alert
                                    color="director"
                                    dark
                                    icon="mdi-alert-circle-outline"
                                    dense
                            >
                                The workflow
                                <strong>{{ selectedWorkflow.fullname }}</strong> will be
                                canceled.
                            </v-alert>
                        </v-card-text>
                        <v-card-actions>
                            <v-spacer></v-spacer>
                            <div class="my-2 ma-2">
                                <v-btn depressed @click.stop="cancelDialog = false"
                                >Cancel
                                </v-btn
                                >
                            </div>
                            <div class="my-2">
                                <v-btn
                                        depressed
                                        color="primary"
                                        @click.stop="cancelWorkflow()"
                                >Confirm
                                </v-btn
                                >
                            </div>
                        </v-card-actions>
                    </v-card>
                </v-dialog>
                <v-dialog v-model="relaunchDialog" max-width="650">
                    <v-card v-if="selectedWorkflow">
                        <v-card-title>
                            Relaunch the workflow
                            <v-spacer></v-spacer>
                        </v-card-title>
                        <v-divider></v-divider>
                        <v-card-text class="mt-5">
                            <v-alert
                                    color="director"
                                    dark
                                    icon="mdi-alert-circle-outline"
                                    dense
                            >
                                The workflow
                                <strong>{{ selectedWorkflow.fullname }}</strong> will be
                                relaunched with the same payload.
                            </v-alert>
                            <i
                            >Note that a new workflow will be created, so the current one
                                (created on {{ selectedWorkflow.created | formatDate }}) will
                                not be changed and will still be available in your history.</i
                            >
                        </v-card-text>
                        <v-card-actions>
                            <v-spacer></v-spacer>
                            <div class="my-2 ma-2">
                                <v-btn depressed @click.stop="relaunchDialog = false"
                                >Cancel
                                </v-btn
                                >
                            </div>
                            <div class="my-2">
                                <v-btn
                                        depressed
                                        color="primary"
                                        @click.stop="relaunchWorkflow()"
                                >Confirm
                                </v-btn
                                >
                            </div>
                        </v-card-actions>
                    </v-card>
                </v-dialog>
                <v-dialog v-model="payloadDialog" width="500">
                    <v-card v-if="selectedWorkflow">
                        <v-card-title>Workflow's Payload</v-card-title>
                        <v-divider></v-divider>
                        <v-card-text class="mt-5">
                            <pre>{{ selectedWorkflow.payload }}</pre>
                        </v-card-text>
                    </v-card>
                </v-dialog>
            </v-main>
            <!-- Home Ends -->

            <!-- Definitions Begins -->
            <v-main v-if="isHome==false">
                <!-- snackbar success -->
                <v-snackbar
                        v-model="snackbar"
                        :multi-line="multiLine"
                        v-if="dialogState == 'success'"
                        top
                        right
                        absolute
                        color="success"
                        :timeout="-1"
                        outlined
                >
                    <a @click="selectRow({id: postWorkflowResponse.id})"
                       class="nav-link"
                       style="cursor: pointer"
                    >
                        Open workflow : {{ postWorkflowResponse.name }}
                        {{ postWorkflowResponse.id }}
                    </a>

                    <template v-slot:action="{ attrs }">
                        <v-btn
                                text
                                v-bind="attrs"
                                @click="snackbar = false, dialogState=''"
                        >
                            Close
                        </v-btn>
                    </template>
                </v-snackbar>

                <!-- snackbar error -->
                <v-container>
                    <v-row>
                        <v-col cols="12" md="8">
                            <v-card class="pa-4" outlined>
                                <div>Definitions</div>
                                <v-card-text>
                                    <v-simple-table>
                                        <template v-slot:default>
                                            <thead>
                                            <tr>
                                                <th class="text-left">User Code</th>
                                                <th class="text-left">Name</th>
                                                <th class="text-left">Periodic</th>
                                                <th class="text-left">Role</th>
                                                <th class="text-left">Run</th>
                                            </tr>
                                            </thead>
                                            <tbody>
                                            <tr
                                                    v-for="item in definitions"
                                                    :key="item.user_code"
                                            >
                                                <td>{{ item.user_code }}</td>
                                                <td>{{ item.name }}</td>
                                                <td v-if="!item.periodic"></td>
                                                <td v-if="item.periodic">
                                                    {{ item.periodic.crontab }} {{ item.periodic.interval }}
                                                    <v-icon small> mdi-clock</v-icon>
                                                </td>
                                                <td>
                                                    <span v-if="item.is_manager">Manager</span>
                                                    <span v-if="!item.is_manager">Worker</span>
                                                </td>
                                                <!-- run button begins here -->
                                                <td>
                                                    <v-btn
                                                            elevation="0"
                                                            fab
                                                            x-small
                                                            v-on:click="runButton(item)"
                                                            :disabled="isWorkflowRun == true"
                                                    >
                                                        <v-icon dense> mdi-play</v-icon>
                                                    </v-btn>
                                                </td>
                                                <!-- run button ends here -->
                                            </tr>
                                            </tbody>
                                        </template>
                                    </v-simple-table>
                                </v-card-text>
                            </v-card>
                        </v-col>
                    </v-row>
                </v-container>
            </v-main>
            <v-dialog v-model="dialog" persistent max-width="600px">
                <v-card>
                    <v-card-title>
                        <span class="text-h5">Payload Information</span>
                    </v-card-title>
                    <v-card-text>
                        <v-container>
                            <p v-if="selectedRunningWorkflow != null">
                                You are about to run workflow
                                <strong>{{ selectedRunningWorkflow.user_code }}</strong>
                            </p>
                            <v-row>
                                <v-col cols="12" sm="12" md="12">
                                    <v-textarea
                                            class="monospacedPayload"
                                            v-model="payloadValue"
                                            label="(optional) Fill the payload here :"
                                            type="json"
                                            required
                                            auto-grow
                                            font-family="Monospace"
                                    >
                                    </v-textarea>
                                </v-col>
                            </v-row>
                        </v-container>
                    </v-card-text>
                    <v-card-actions>
                        <v-spacer></v-spacer>
                        <v-btn
                                color="blue darken-1"
                                text
                                @click="dialog = false, snackbar=false,  State=''"
                        >
                            Close
                        </v-btn>
                        <v-btn
                                color="blue darken-1"
                                text
                                @click="dialog = false, runWorkflow()"
                        >
                            Run
                        </v-btn>
                    </v-card-actions>
                </v-card>
            </v-dialog>
            <!-- Definitions Ends -->
        </v-app>

    </div>
    {% endverbatim %}
</div>
    <script src="{% static 'script.js' %}"></script>

</body>
</html>
